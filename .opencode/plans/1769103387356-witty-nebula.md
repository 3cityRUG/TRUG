# Rails Migration Plan: TRUG Middleman to Rails 8

## Overview
Migrate the TRUG static site from Middleman to Rails 8 with SQLite database, pure CSS, vanilla JS, Minitest, and Kamal deployment.

## Current State
- **Framework**: Middleman 4.4.2 (static site generator)
- **Ruby**: 3.2.2
- **Data**: YAML file (`data/meetups.yml`) with 115+ meetup events
- **CSS**: Sass with custom Hocus-Pocus framework
- **JS**: Vanilla JS (2 files)
- **Deployment**: GitHub Actions → GitHub Pages
- **Templating**: ERB + HAML

## Target State
- **Framework**: Rails 8 (latest stable)
- **Ruby**: 3.3+ (use latest stable)
- **Database**: SQLite with Active Record
- **CSS**: Pure CSS (no preprocessor, no frameworks)
- **JS**: Vanilla JS (no bundlers)
- **Testing**: Minitest
- **Deployment**: Kamal to self-hosted VPS

## Phase 1: New Rails Application Setup

### 1.1 Create New Rails App
```bash
rails new trug-rails \
  --database=sqlite3 \
  --javascript=importmap \
  --css=pure \
  --skip-test \
  --skip-git
```

### 1.2 Configure Gemfile
Remove default gems and add minimal dependencies:
- `kamal` for deployment
- `minitest` (default in Rails)
- `capybara`, `selenium-webdriver` for system tests

### 1.3 Directory Structure
```
app/
├── assets/stylesheets/  # Pure CSS files
├── assets/javascripts/  # Vanilla JS files
├── models/              # Meetup, Talk models
├── controllers/         # PagesController
├── views/               # ERB templates
├── helpers/             # View helpers
├── mailers/             # If needed
└── jobs/                # If needed
```

## Phase 2: Database Schema Design

### 2.1 Meetups Table
```ruby
create_table "meetups" do |t|
  t.integer "number", null: false
  t.date "date", null: false
  t.string "location"
  t.text "description"
  t.timestamps
end
```

### 2.2 Talks Table
```ruby
create_table "talks" do |t|
  t.references "meetup", null: false
  t.string "title", null: false
  t.string "speaker_name", null: false
  t.string "speaker_homepage"
  t.string "slides_url"
  t.string "source_code_url"
  t.string "video_id"
  t.string "video_provider"  # "youtube" or "vimeo"
  t.string "video_thumb"
  t.timestamps
end
```

### 2.3 Indexes
- `meetups.number` (unique)
- `talks.meetup_id`

### 2.4 Model Relationships
```ruby
class Meetup < ApplicationRecord
  has_many :talks, dependent: :destroy
  validates :number, presence: true, uniqueness: true
  validates :date, presence: true
  scope :ordered, -> { order(date: :desc) }
end

class Talk < ApplicationRecord
  belongs_to :meetup
  validates :title, presence: true
  validates :speaker_name, presence: true
end
```

## Phase 3: Data Migration

### 3.1 Create Rake Task
Create `lib/tasks/migrate_meetups.rake` to import from YAML:
- Parse `data/meetups.yml`
- Create Meetup records
- Create associated Talk records
- Log statistics

### 3.2 Run Migration
```bash
rails db:migrate
rails meetups:migrate_from_yaml
rails db:seed  # Optional verification
```

## Phase 4: Controllers

### 4.1 PagesController
```ruby
class PagesController < ApplicationController
  def home
    @next_meetup = Meetup.ordered.first
    @recent_meetups = Meetup.ordered.offset(1).limit(5)
  end

  def archive
    @meetups = Meetup.ordered.includes(:talks)
  end
end
```

### 4.2 Routes
```ruby
root "pages#home"
get "/archive", to: "pages#archive"
```

## Phase 5: Views (Convert from Middleman)

### 5.1 Layout (`app/views/layouts/application.html.erb`)
- Navbar with logo and archive link
- Flash messages
- Footer with newsletter form
- Open Graph meta tags
- Google Fonts (Lato)

### 5.2 Homepage (`app/views/pages/home.html.erb`)
- Next meetup details (from `@next_meetup`)
- Location map
- Community info
- Speaker list with talks

### 5.3 Archive Page (`app/views/pages/archive.html.erb`)
- All meetups with video embeds
- Video lazy-loading (YouTube/Vimeo)
- Speaker info with links

### 5.4 View Helpers
Create helpers in `app/helpers/`
- `format_meetup_header(meetup)`
- `talk_title_with_links(talk)`
- `speaker_info(talk)`
- `video_embed(talk)`

## Phase 6: CSS (Pure CSS Migration)

### 6.1 Migrate from Sass
Convert `source/stylesheets/` to pure CSS:
- Variables → CSS custom properties (`--color-brand`, etc.)
- Mixins → CSS `@layer` or utility classes
- Nesting → Explicit selectors
- Hocus-Pocus framework → Modular CSS files

### 6.2 CSS Structure
```
app/assets/stylesheets/
├── application.css     # Main entry
├── variables.css       # Design tokens
├── reset.css           # CSS reset
├── layout.css          # Header, footer
├── components.css      # Buttons, cards, forms
├── pages/
│   ├── home.css
│   └── archive.css
└── vendor/             # External (if needed)
```

### 6.3 Color Variables
```css
:root {
  --color-brand: #e25454;
  --color-brand-muted: #f0a0a0;
  --color-brand-dark: #c43c3c;
  --color-light: #ffffff;
  --color-dark: #505050;
  --font-family: 'Lato', sans-serif;
}
```

## Phase 7: JavaScript (Vanilla JS)

### 7.1 Move Existing JS
- `source/javascripts/archive.js` → `app/assets/javascripts/archive.js`
- `source/javascripts/site.js` → `app/assets/javascripts/site.js`

### 7.2 Video Embed Enhancement
Convert to use Turbo Streams or plain JS with data attributes:
```javascript
document.querySelectorAll('[data-video-embed]').forEach(el => {
  el.addEventListener('click', loadVideo);
});
```

### 7.3 Application.js
```javascript
//= require archive
//= require site
```

## Phase 8: Testing Setup (Minitest)

### 8.1 Model Tests
```ruby
# test/models/meetup_test.rb
class MeetupTest < ActiveSupport::TestCase
  test "validations" do
    meetup = Meetup.new
    assert_not meetup.valid?
    assert_includes meetup.errors[:number], "can't be blank"
  end

  test "ordered scope" do
    assert_equal Meetup.ordered, Meetup.order(date: :desc)
  end
end
```

### 8.2 System Tests
```ruby
# test/system/pages_test.rb
require "application_system_test_case"

class PagesTest < ApplicationSystemTestCase
  test "homepage shows next meetup" do
    visit root_url
    assert_text "TRUG"
  end

  test "archive page lists all meetups" do
    visit archive_url
    assert_selector ".meetup", count: Meetup.count
  end
end
```

### 8.3 Controller Tests
```ruby
# test/controllers/pages_controller_test.rb
class PagesControllerTest < ActionDispatch::IntegrationTest
  test "GET / returns success" do
    get root_url
    assert_response :success
  end
end
```

### 8.4 Fixtures
Create `test/fixtures/meetups.yml` and `test/fixtures/talks.yml`

## Phase 9: Kamal Deployment

### 9.1 Server Requirements
- Ubuntu 22.04 LTS VPS (or similar)
- SSH access with sudo
- Domain: trug.pl pointing to server

### 9.2 Kamal Setup
```bash
kamal setup
kamal deploy
```

### 9.3 Deploy Configuration (`config/deploy.yml`)
```yaml
# config/deploy.yml
service: trug

image: trug-rails

servers:
  web:
    - 192.0.2.1

registry:
  username: trug-bot
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  secret:
    - RAILS_MASTER_KEY

healthcheck:
  path: /health
  port: 3000

volumes:
  - "trug-storage:/rails/storage"

accessories:
  db:
    image: postgres:16-alpine  # Or use SQLite with persistent volume
    volumes:
      - "trug-db:/rails/db"

  redis:
    image: redis:7-alpine
    volumes:
      - "trug-redis:/data"
```

### 9.4 Alternative: SQLite with Persistent Volume
For SQLite, configure persistent storage:
```yaml
volumes:
  - "trug-storage:/rails/storage"
  - "trug-sqlite:/rails/db"
```

### 9.5 Dockerfile Considerations
Rails 8 with Kamal uses the `kambuilder` imageal/:
- Multi-stage build
- No Procfile needed (uses Kamal's default)
- Assets precompiled during build

## Phase 10: CI/CD Pipeline

### 10.1 GitHub Actions Workflow
Create `.github/workflows/ci.yml`:
```yaml
name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3
          bundler-cache: true
      - run: bin/rails test
      - run: bin/rails test:system

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
      - run: bin/rails assets:precompile
      - uses: gh-pages/gh-pages-style@v3
        with:
          deploy-key: ${{ secrets.DEPLOY_KEY }}
          target-branch: gh-pages
```

### 10.2 Remove Old Deployment
- Delete `.github/workflows/deploy.yml`
- Delete `Rakefile` (middleman-gh-pages)
- Delete `config.rb` (Middleman config)

## Phase 11: Asset Pipeline

### 11.1 CSS Compilation
Rails 8 with `css = pure` uses:
- No Tailwind
- No Sass preprocessor
- Pure CSS files in `app/assets/stylesheets/`

### 11.2 JavaScript
- Use importmap for ES modules
- No bundler (esbuild, webpacker removed)

### 11.3 Assets Structure
```
app/assets/
├── config/
│   └── manifest.js
├── stylesheets/
│   └── application.css
└── javascripts/
    └── application.js
```

## Phase 12: Domain & DNS

### 12.1 DNS Configuration
- A record: trug.pl → VPS IP
- www CNAME → trug.pl (optional)

### 12.2 Kamal Traefik Setup
Configure Traefik for HTTPS:
```yaml
# config/deploy.yml
traefik:
  options:
    - "--entrypoints.websecure.http.tls=true"
    - "--entrypoints.websecure.http.tls.certresolver=letsencrypt"
```

## Phase 13: Verification Checklist

### 13.1 Local Testing
```bash
bin/rails test              # Unit tests
bin/rails test:system       # System tests
bin/rails test:jobs         # Job tests (if any)
bin/rails db:seed           # Verify data import
bin/rails assets:precompile # Verify asset pipeline
```

### 13.2 Staging Deploy
```bash
KAMAL_ENV=staging kamal setup
KAMAL_ENV=staging kamal deploy
```

### 13.3 Production Deploy
```bash
kamal setup
kamal deploy
```

### 13.4 Smoke Tests
- Homepage loads correctly
- Archive page shows all meetups
- Videos embed on click
- Mobile responsiveness works
- SSL certificate active

## Critical Files to Modify

| File | Action |
|------|--------|
| `Gemfile` | Replace with Rails 8 + dependencies |
| `config/database.yml` | SQLite configuration |
| `config/routes.rb` | Add routes |
| `app/models/meetup.rb` | New model |
| `app/models/talk.rb` | New model |
| `app/controllers/pages_controller.rb` | New controller |
| `app/views/pages/*.html.erb` | New views |
| `app/assets/stylesheets/*.css` | Convert from Sass |
| `app/assets/javascripts/*.js` | Move existing JS |
| `config/deploy.yml` | New Kamal config |
| `.github/workflows/ci.yml` | New CI pipeline |

## Rollback Plan

1. Keep Middleman repo as backup until Rails is verified
2. Use Kamal's rollback: `kamal rollback`
3. Revert DNS to GitHub Pages if needed
4. Keep old `build/` directory temporarily

## Estimated Timeline

1. **Setup & Schema**: 1-2 days
2. **Data Migration**: 1 day
3. **Views & Assets**: 2-3 days
4. **Testing**: 1-2 days
5. **Kamal Setup**: 1 day
6. **CI/CD**: 1 day
7. **Deployment & Verification**: 1-2 days

**Total**: ~8-12 days
