<% next_meetup = local_assigns[:next_meetup] || @next_meetup %>
<div class="attendance-section">
  <h3>Kto będzie?</h3>
  <% confirmed = next_meetup.attendances.confirmed %>
  <% maybe = next_meetup.attendances.where(status: Attendance::STATUSES[:maybe]) %>
  <% no = next_meetup.attendances.where(status: Attendance::STATUSES[:no]) %>

  <% if confirmed.any? || maybe.any? %>
    <div class="attendance-avatars">
      <% confirmed.each do |attendance| %>
        <a href="https://github.com/<%= attendance.github_username %>" target="_blank" rel="noopener" class="attendance-avatar attendance-avatar--yes" title="<%= attendance.github_username %> (będę)">
          <img src="https://github.com/<%= attendance.github_username %>.png?size=44" alt="<%= attendance.github_username %>" onerror="this.src='https://github.com/identicons/<%= attendance.github_username %>.png'">
        </a>
      <% end %>
      <% maybe.each do |attendance| %>
        <a href="https://github.com/<%= attendance.github_username %>" target="_blank" rel="noopener" class="attendance-avatar attendance-avatar--maybe" title="<%= attendance.github_username %> (może)">
          <img src="https://github.com/<%= attendance.github_username %>.png?size=44" alt="<%= attendance.github_username %>" onerror="this.src='https://github.com/identicons/<%= attendance.github_username %>.png'">
          <span class="attendance-avatar__badge">?</span>
        </a>
      <% end %>
    </div>
    <p class="attendance-count">
      <%= confirmed.count %> osób potwierdziło<% if maybe.any? %>, <%= maybe.count %> może<% end %>
    </p>
  <% else %>
    <p class="no-attendees">Bądź pierwszy i zgłoś obecność!</p>
  <% end %>

  <% if authenticated? && current_user.github_username %>
    <% user_attendance = next_meetup.attendances.find_by(github_username: current_user.github_username) %>
    <div class="attendance-form">
      <%= form_with url: attendances_path, method: :post, class: "attendance-cycle-form", data: { turbo_frame: "attendance_section_#{next_meetup.id}" } do |f| %>
        <%= f.hidden_field :meetup_id, value: next_meetup.id %>
        <%= f.hidden_field :status, value: user_attendance ? user_attendance.next_status : Attendance::STATUSES[:yes] %>
        <% if user_attendance %>
          <p class="attendance-status">Twoja odpowiedź: <span class="status-<%= user_attendance.status_name %>"><%= user_attendance.status_label %></span></p>
          <%= f.submit "Zmień na: #{Attendance.status_label(user_attendance.next_status)}", class: "btn btn-brand" %>
        <% else %>
          <%= f.submit "Zgłoś obecność (Tak, będę!)", class: "btn btn-brand" %>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <div class="attendance-form">
      <p class="form-note">Zaloguj się przez GitHub, aby zgłosić obecność:</p>
      <a href="/auth/github" class="btn btn-brand" data-turbo="false">Zaloguj przez GitHub</a>
    </div>
  <% end %>
</div>
